description: Calls somatic variants using Mutect2 (GATK) for a tumor/normal pair.
args:
    - FASTA_FILE:
        default: "Null"
        opts: "-r | --reference"
        description: "Name of the reference genome FASTA file."
        required: True
        example: "-r hg19.fa"
    - TUMOR_BAM_FILE:
        default: "Null"
        opts: "-m | --tumor_bam_file"
        description: "Path to a BAM file with tumor data."
        required: True
        example: "-m SampleA_Tumor.bam"
    - NORMAL_BAM_FILE:
        default: "Null"
        opts: "-n | --normal_bam_file"
        description: "Path to a BAM file with normal data."
        required: True
        example: "-n SampleA_Normal.bam"
    - OUTPUT_FILE:
        default: "Null"
        opts: "-o | --output"
        description: "Name of the output VCF file."
        required: True
        example: "-o SampleA.vcf"
    - THREADS:
        default: 1
        opts: "-t | --nthreads"
        description: "The number of threads that GATK should use."
        required: False
        example: "-t 4"
volumes:
    - ref_dir:
        description: "Directory where the reference genome FASTA file and indices are stored."
        permissions: Read
    - input_bam_dir:
        description: "Directory where the input BAM file is stored."
        permissions: Read
    - output_vcf_dir:
        description: "Directory where the output BAM file will be stored."
        permissions: ReadWrite
command_template: |
    ln -s /data/ref_dir/"${FASTA_FILE}" /tmp/"${FASTA_FILE}"

    INDEX=$(echo ${FASTA_FILE} | grep -o '\.' | grep -c '\.')
    if [[ ${FASTA_FILE: -${INDEX}} = ".gz" ]]; then
        NEW_REF="$(echo ${FASTA_FILE} | cut -d '.' -f -${INDEX})"
        gunzip -c /data/ref_dir/"${FASTA_FILE}" > /tmp/"${NEW_REF}"
        FASTA_FILE="${NEW_REF}"
        INDEX=$(echo ${FASTA_FILE} | grep -o '\.' | grep -c '\.')
    fi

    NEEDED_INDEX=/data/ref_dir/"${FASTA_FILE}".fai
    REF_DICT="$(echo ${FASTA_FILE} | cut -d '.' -f -${INDEX})".dict
    NEEDED_DICT=/data/ref_dir/"${REF_DICT}"

    if [[ ! -f "${NEEDED_INDEX}" ]]; then
        echo "Samtools reference index (${NEEDED_INDEX}) is missing."
        exit 1
    fi

    ln -s /data/ref_dir/"${FASTA_FILE}.fai" /tmp/"${FASTA_FILE}.fai"

    if [[ ! -f ${NEEDED_DICT} ]]; then
        echo "Fasta dict file (${NEEDED_DICT}) is missing."
        exit 1
    fi

    ln -s /data/ref_dir/"${REF_DICT}" /tmp/"${REF_DICT}"

    gatk4 Mutect2 -I /data/input_bam_dir/"${TUMOR_BAM_FILE}" -tumor "${TUMOR_BAM_FILE/\.bam/}" \
      -I /data/input_bam_dir/"${NORMAL_BAM_FILE}" -normal "${NORMAL_BAM_FILE/\.bam/}" \
      -O /data/output_vcf_dir/"${OUTPUT_FILE}" -R /tmp/"${FASTA_FILE}" \
      --nativePairHmmThreads $THREADS
receipt_commands: |
    get_bash_version
    get_conda_version gatk4