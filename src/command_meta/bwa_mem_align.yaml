description: Align FASTQ files to a reference genome using the Burrows-Wheeler Aligner software (bwa mem). Default options are used for bwa mem unless specified otherwise.
args:
    - REF_GENOME:
        default: "Null"
        opts: "-r | --reference"
        description: "Name of the reference genome FASTA file."
        required: True
        example: "-r hg19.fa"
    - READS1:
        default: "Null"
        opts: "-s1 | --sample1"
        description: "Name of the first FASTQ file."
        required: True
        example: "-s1 SampleA_1.fastq.gz"
    - READS2:
        default: "Null"
        opts: "-s2 | --sample2"
        description: "Name of the second FASTQ file."
        required: True
        example: "-s2 SampleA_2.fastq.gz"
    - OUTPUT:
        default: "Null"
        opts: "-o | --output"
        description: "Name of the output BAM file."
        required: True
        example: "-o SampleA.bam"
    - THREADS:
        default: 1
        opts: "-t | --nthreads"
        description: "The number of threads that BWA should use during alignment."
        required: False
        example: "-t 4"
    - CHUNKS:
        default: 1
        opts: "-c | --nchunks"
        description: "This argument indicates how the FASTQ files should be \"chunked\" during the alignment process. When this feature is enabled, a subset (chunk) of the FASTQ data will be streamed into BWA. Accordingly, different chunks of the file can be aligned in parallel, potentially reducing execution times. This argument indicates the total number of chunks (default of 1 indicates no chunking). When performing chunking, you should also specify the --process_chunk argument, which indicates the chunk number that should be processed (this counting scheme is zero-based)."
        required: False
    - PROCESS_CHUNK:
        default: 0
        opts: "-p | --process_chunk"
        description: "This argument indicates the chunk number to be processed. Please see the description for the --nchunks argument."
        required: False
    - READ_GROUP_STRING:
        default: ""
        opts: "-rg | --read-group"
        description: "This argument allows you to specify read-group information during alignment. Please specify the whole read-group string, including the @RG prefix, surround in quotes. You can find a helpful tutorial here: https://software.broadinstitute.org/gatk/documentation/article.php?id=6472."
        required: False
        example: "-rg \"@RG\\tID:SampleA_lane1\\tPL:ILLUMINA\\tPU:SampleA_lane1\\tLB:SampleA_lane1\\tSM:SampleA\""
    - SORT:
        default: False
        opts: "--sort"
        description: "Whether the output BAM file should be sorted after alignment. Acceptable values are True or False."
        required: False
        acceptable_values:
            - False
            - True
        example: "--sort True"
    - INDEX:
        default: False
        opts: "--index"
        description: "Whether the output BAM file should be indexed after alignment. Acceptable values are True or False."
        required: False
        acceptable_values:
            - False
            - True
        example: "--index True"
volumes:
    - ref_genome:
        description: "Directory where the reference genome FASTA file is stored."
        permissions: Read
    - ref_index:
        description: "Directory where the index files for the reference genome are stored."
        permissions: Read
    - input_data:
        description: "Directory where the FASTQ files are stored."
        permissions: ReadWrite
    - output_data:
        description: "Directory where the output files will be stored."
        permissions: ReadWrite
command_template: |
    NEEDED_FILES=("${REF_GENOME}".amb "${REF_GENOME}".ann "${REF_GENOME}".bwt "${REF_GENOME}".pac "${REF_GENOME}".sa)
    REF_INDEX_FILES=()
    for filename in /data/ref_index/*; do
        REF_INDEX_FILES+=($(echo "${filename##*/}"))
    done

    for NEEDED_FILE in ${NEEDED_FILES[@]}; do
        { [[ " ${REF_INDEX_FILES[@]} " =~ " ${NEEDED_FILE} " ]] \
        && ln -s /data/ref_index/"${NEEDED_FILE}" /tmp/"${NEEDED_FILE}"; } || REF_INDEXED=1
    done

    if [[ ${REF_INDEXED} == 1 ]]; then
        echo "The reference genome does not contain the proper index files."
        exit 1
    fi

    COMMAND_STRING="bwa mem -t ${THREADS} "

    if [[ "$READ_GROUP_STRING" != "" ]]
    then
      COMMAND_STRING+="-R \"$READ_GROUP_STRING\" "
    fi

    COMMAND_STRING+="/tmp/\"${REF_GENOME}\" "

    if [[ ${CHUNKS} -gt 1 ]]
    then
      COMMAND_STRING+="<(zcat /data/input_data/\"${READS1}\" | awk -v chunks=${CHUNKS} -v process_chunk=${PROCESS_CHUNK} 'int((NR-1)/4)%chunks==process_chunk') "
      COMMAND_STRING+="<(zcat /data/input_data/\"${READS2}\" | awk -v chunks=${CHUNKS} -v process_chunk=${PROCESS_CHUNK} 'int((NR-1)/4)%chunks==process_chunk') "
    else
      COMMAND_STRING+="/data/input_data/\"${READS1}\" /data/input_data/\"${READS2}\" "
    fi

    OUTPUT_PATH=/data/output_data/"${OUTPUT}"

    if [[ ${CHUNKS} -gt 1 ]]; then
      INDEX=$(echo ${OUTPUT} | grep -o '\.' | grep -c '\.')
      OUT_NAME="$(echo ${OUTPUT} | cut -d '.' -f -${INDEX})"
      OUTPUT_PATH=/data/output_data/"${OUT_NAME}".${PROCESS_CHUNK}.bam
    fi

    if [[ "$SORT" == "True" ]]
    then
      COMMAND_STRING+="| samtools sort -@ ${THREADS} -o \"${OUTPUT_PATH}\" - "
    else
      COMMAND_STRING+="| samtools view -@ ${THREADS} -b > \"${OUTPUT_PATH}\" "
    fi

    if [[ "$INDEX" == "True" ]]
    then
      COMMAND_STRING+=" && sambamba index -t ${THREADS} \"${OUTPUT_PATH}\" \"${OUTPUT_PATH}\".bai"
    fi

    eval "$COMMAND_STRING"
receipt_commands: |
    get_bash_version
    get_python_version
    get_conda_version bwa
    get_conda_version samtools
    get_conda_version sambamba
