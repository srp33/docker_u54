description: Apply base quality score recalibration to a BAM file.
args:
    - FASTA_FILE:
        opts: "-r | --reference"
        description: "Name of the reference genome FASTA file."
        example: "hg19.fa"
    - BQSR_FILE:
        opts: "-q | --bqsr_recal_file | -BQSR"
        description: "Path to a file with BQSR_FILE data."
        example: "myscores.bqsr"
    - INPUT_BAM_FILE:
        opts: "-i | --input"
        description: "Name of the input BAM file."
        example: "SampleA.bam"
    - OUTPUT_BAM_FILE:
        opts: "-o | --output"
        description: "Name of the output BAM file. If no value is specified, the output file will have the same name as the input file."
        default: "Null"
        example: "SampleA.bam"
    - THREADS:
        opts: "-t | --nthreads"
        description: "The number of threads that GATK should use. Default is 1."
        default: 1
        example: "4"
volumes:
    - ref_dir:
        description: "Directory where the reference genome FASTA file and indices are stored."
    - input_bam_dir:
        description: "Directory where the input BAM file is stored."
    - bqsr_dir:
        description: "Directory where the BQSR_FILE file is stored."
    - output_bam_dir:
        description: "Directory where the output BAM file will be stored."
        write_access: True
command_template: |
    if [[ "$OUTPUT_BAM_FILE" == "Null"]]
    then
        OUTPUT_BAM_FILE="$INPUT_BAM_FILE"
    fi

    #ln -s /volumes/ref_dir/"${FASTA_FILE}" /tmp/"${FASTA_FILE}"
    #ln -s /volumes/ref_dir/"${FASTA_FILE}".fai /tmp/"${FASTA_FILE}".fai
    #ln -s /volumes/ref_dir/"${FASTA_FILE/\.fa/.dict}" /tmp/"${FASTA_FILE/\.fa/.dict}"

    gatk3 -Xms512m -Xmx8g -T PrintReads 
        -R /volumes/ref_dir/"${FASTA_FILE}" \
        -I /volumes/input_bam_dir/"${INPUT_BAM_FILE}" \
        -BQSR /volumes/bqsr_dir/"${BQSR_FILE}" \
        -o /volumes/output_bam_dir/"${OUTPUT_BAM_FILE}" \
        -nct "${THREADS}"
receipt_commands: |
    get_bash_version
    gatk3 --version