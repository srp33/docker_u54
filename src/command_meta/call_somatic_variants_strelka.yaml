description: Calls somatic variants using Strelka for a tumor/normal pair.
args:
    - FASTA_FILE:
        default: "Null"
        opts: "-r | --reference"
        description: "Name of the reference genome FASTA file."
        required: True
        example: "-r hg19.fa"
    - TUMOR_BAM_FILE:
        default: "Null"
        opts: "-m | --tumor_bam_file"
        description: "Path to a BAM file with tumor data."
        required: True
        example: "-m SampleA_Tumor.bam"
    - NORMAL_BAM_FILE:
        default: "Null"
        opts: "-n | --normal_bam_file"
        description: "Path to a BAM file with normal data."
        required: True
        example: "-n SampleA_Normal.bam"
    - OUTPUT_FILE:
        default: "Null"
        opts: "-o | --output"
        description: "Name of the output VCF file."
        required: True
        example: "-o SampleA.vcf"
    - INDEL_CANDIDATES_FILE:
        default: ""
        opts: "-i | --indel_candidates_file"
        description: "The Strelka documentation recommends to provide indel candidates from the Manta SV and indel caller to improve sensitivity to call indels of size 20 or larger. You may specify the name of a VCF file with these candidates. This file can be created using the call_structural_variants_manta command."
        required: False
        example: "-i candidateSmallIndels.vcf.gz"
    - CALL_REGIONS_FILE:
        default: ""
        opts: "-c, --call_regions_file"
        description: "The Strelka documentation recommends that for references with many short contigs, to provide callable regions to avoid possible runtime issues. You may specify the name of a BED file containing genomic regions to call."
        required: False
        example: "-c regions.bed.gz"
    - EXOME:
        default: False
        opts: "-e | --exome"
        description: "For exome and amplicon sequencing, enable this setting. Acceptable values are True or False."
        required: False
        acceptable_values:
            - False
            - True
        example: "--exome True"
    - THREADS:
        default: 1
        opts: "-t | --nthreads"
        description: "The number of threads that should be used."
        required: False
        example: "-t 4"
volumes:
    - ref_genome:
        description: "Directory where the reference genome FASTA file is stored."
        permissions: Read
    - ref_index:
        description: "Directory where the index files for the reference genome are stored."
        permissions: Read
    - bam_files:
        description: "Directory where the BAM file is stored."
        permissions: Read
    - output_data:
        description: "Directory where the output file will be stored."
        permissions: ReadWrite
command_template: |
    if [ ! -f /data/bam_files/"${TUMOR_BAM_FILE}.bai" ] then
      echo "ERROR: /data/bam_files/\"${TUMOR_BAM_FILE}.bai\" does not exist. Please run index_bam on /data/bam_files/\"${TUMOR_BAM_FILE}\"."
      exit 1;
    fi
    if [ ! -f /data/bam_files/"${NORMAL_BAM_FILE}.bai" ] then
      echo "ERROR: /data/bam_files/\"${NORMAL_BAM_FILE}.bai\" does not exist. Please run index_bam on /data/bam_files/\"${NORMAL_BAM_FILE}\"."
      exit 1;
    fi

    ln -s /data/ref_genome/"${FASTA_FILE}" /tmp/"${FASTA_FILE}"

    INDEX=$(echo "${FASTA_FILE}" | grep -o '\.' | grep -c '\.')
    if [[ "${FASTA_FILE: -${INDEX}}" = ".gz" ]]; then
        NEW_REF="$(echo ${FASTA_FILE} | cut -d '.' -f -${INDEX})"
        gunzip -c /data/ref_genome/"${FASTA_FILE}" > /tmp/"${NEW_REF}"
        FASTA_FILE="${NEW_REF}"
    fi

    NEEDED_FILE=/data/ref_index/"${FASTA_FILE}".fai

    if [[ ! -f "${NEEDED_FILE}" ]]; then
        echo "samtools reference index (${NEEDED_FILE}) is missing."
        exit 1
    fi

    ln -s /data/ref_index/"${FASTA_FILE}.fai" /tmp/"${FASTA_FILE}.fai"

    RUN_DIR="/data/output_data/StrelkaSomaticWorkflow"
    RUN_DIR_ARG="--runDir=${RUN_DIR}"
    rm -f "${RUN_DIR_ARG##*=}/runWorkflow.py"

    if [[ "$INDEL_CANDIDATES_FILE" != "" ]]
    then
      INDEL_CANDIDATES_FILE="--INDEL_CANDIDATES_FILECandidates /data/input_data/$INDEL"
    fi

    if [[ "$CALL_REGIONS_FILE" != "" ]]
    then
      CALL_REGIONS_FILE="--callRegions /data/input_data/$CALL_REGIONS_FILE"
    fi

    if [[ "$EXOME" == "True" ]]
    then
      EXOME="--exome"
    fi

    #source activate py2.7

    python2.7 /miniconda/envs/py2.7/share/strelka-2.9.10-0/bin/configureStrelkaSomaticWorkflow.py \
        --referenceFasta=/tmp/"${FASTA_FILE}" --tumorBam="/data/bam_files/${TUMOR_BAM_FILE}" \
        --normalBam="/data/bam_files/${NORMAL_BAM_FILE}" ${INDEL_CANDIDATES_FILE} ${CALL_REGIONS_FILE} "${RUN_DIR_ARG}" \
        ${EXOME}

    python2.7 "${RUN_DIR}"/runWorkflow.py -m local -j $THREADS
receipt_commands: |
    get_bash_version
    get_python2_version
    get_conda_version picard
    echo "Strelka version 2.9.10-0"