description: Calls somatic variants using Strelka for a tumor/normal pair.
args:
    - FASTA_FILE:
        opts: "-r | --reference"
        description: "Name of the reference genome FASTA file."
        example: "hg19.fa"
    - TUMOR_BAM_FILE:
        opts: "-m | --tumor_bam_file"
        description: "Path to a BAM file with tumor data."
        example: "SampleA_Tumor.bam"
    - NORMAL_BAM_FILE:
        opts: "-n | --normal_bam_file"
        description: "Path to a BAM file with normal data."
        example: "SampleA_Normal.bam"
    - OUTPUT_FILE:
        opts: "-o | --output"
        description: "Name of the output VCF file."
        example: "SampleA.vcf"
    - INDEL_CANDIDATES_FILE:
        opts: "-i | --indel_candidates_file"
        description: "The Strelka documentation recommends to provide indel candidates from the Manta SV and indel caller to improve sensitivity to call indels of size 20 or larger. You may specify the name of a VCF file with these candidates. This file can be created using the call_structural_variants_manta command."
        default: "Null"
        example: "candidateSmallIndels.vcf.gz"
    - CALL_REGIONS_FILE:
        opts: "-c, --call_regions_file"
        description: "The Strelka documentation recommends that for references with many short contigs, to provide callable regions to avoid possible runtime issues. You may specify the name of a BED file containing genomic regions to call."
        default: "Null"
        example: "regions.bed.gz"
    - EXOME:
        opts: "-e | --exome"
        description: "For exome and amplicon sequencing, enable this setting. Acceptable values are True or False. Default is False."
        acceptable_values:
            - False
            - True
        default: False
        example: "True"
    - THREADS:
        opts: "-t | --nthreads"
        description: "The number of threads that should be used. Default is 1."
        default: 1
        example: "4"
volumes:
    - ref_dir:
        description: "Directory where the reference genome FASTA file and indices are stored."
    - input_bam_dir:
        description: "Directory where the BAM file is stored."
    - output_vcf_dir:
        description: "Directory where the output file will be stored."
        write_access: True
command_template: |
    if [ ! -f /volumes/input_bam_dir/"${TUMOR_BAM_FILE}.bai" ] then
      echo "ERROR: /volumes/input_bam_dir/\"${TUMOR_BAM_FILE}.bai\" does not exist. Please run index_bam on /volumes/input_bam_dir/\"${TUMOR_BAM_FILE}\"."
      exit 1;
    fi
    if [ ! -f /volumes/input_bam_dir/"${NORMAL_BAM_FILE}.bai" ] then
      echo "ERROR: /volumes/input_bam_dir/\"${NORMAL_BAM_FILE}.bai\" does not exist. Please run index_bam on /volumes/input_bam_dir/\"${NORMAL_BAM_FILE}\"."
      exit 1;
    fi

    ln -s /volumes/ref_dir/"${FASTA_FILE}" /tmp/"${FASTA_FILE}"

    INDEX=$(echo "${FASTA_FILE}" | grep -o '\.' | grep -c '\.')
    if [[ "${FASTA_FILE: -${INDEX}}" = ".gz" ]]; then
        NEW_REF="$(echo ${FASTA_FILE} | cut -d '.' -f -${INDEX})"
        gunzip -c /volumes/ref_dir/"${FASTA_FILE}" > /tmp/"${NEW_REF}"
        FASTA_FILE="${NEW_REF}"
    fi

    NEEDED_FILE=/volumes/ref_dir/"${FASTA_FILE}".fai

    if [[ ! -f "${NEEDED_FILE}" ]]; then
        echo "samtools reference index (${NEEDED_FILE}) is missing."
        exit 1
    fi

    ln -s /volumes/ref_dir/"${FASTA_FILE}.fai" /tmp/"${FASTA_FILE}.fai"

    RUN_DIR="/volumes/output_vcf_dir/StrelkaSomaticWorkflow"
    RUN_DIR_ARG="--runDir=${RUN_DIR}"
    rm -f "${RUN_DIR_ARG##*=}/runWorkflow.py"

    if [[ "$INDEL_CANDIDATES_FILE" != "Null" ]]
    then
      INDEL_CANDIDATES_FILE="--INDEL_CANDIDATES_FILECandidates /volumes/input_data/$INDEL"
    fi

    if [[ "$CALL_REGIONS_FILE" != "Null" ]]
    then
      CALL_REGIONS_FILE="--callRegions /volumes/input_data/$CALL_REGIONS_FILE"
    fi

    if [[ "$EXOME" == "True" ]]
    then
      EXOME="--exome"
    fi

    #source activate py2.7

    python2.7 /miniconda/envs/py2.7/share/strelka-2.9.10-0/bin/configureStrelkaSomaticWorkflow.py \
        --referenceFasta=/tmp/"${FASTA_FILE}" --tumorBam="/volumes/input_bam_dir/${TUMOR_BAM_FILE}" \
        --normalBam="/volumes/input_bam_dir/${NORMAL_BAM_FILE}" ${INDEL_CANDIDATES_FILE} ${CALL_REGIONS_FILE} "${RUN_DIR_ARG}" \
        ${EXOME}

    python2.7 "${RUN_DIR}"/runWorkflow.py -m local -j $THREADS
receipt_commands: |
    get_bash_version
    get_python2_version
    get_conda_version picard
    echo "Strelka version 2.9.10-0"